<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mode 3: Post-Mortem Analysis Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid #1e293b;
            margin-bottom: 30px;
            position: relative;
        }

        .history-btn {
            position: absolute;
            top: 30px;
            right: 20px;
            padding: 8px 16px;
            background: #334155;
            color: #e2e8f0;
            border: 1px solid #475569;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .history-btn:hover {
            background: #475569;
            border-color: #64748b;
        }

        .history-count {
            background: #ef4444;
            color: #fff;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-left: 6px;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #94a3b8;
            font-size: 1rem;
        }

        .call-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .call-type-card {
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .call-type-card:hover {
            border-color: #ef4444;
            transform: translateY(-2px);
        }

        .call-type-card.active {
            border-color: #ef4444;
            background: #2d1a1a;
        }

        .call-type-card h3 {
            color: #ef4444;
            margin-bottom: 4px;
            font-size: 1rem;
        }

        .call-type-card p {
            color: #94a3b8;
            font-size: 0.85rem;
        }

        .input-section {
            background: #1e293b;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .input-section h2 {
            color: #ef4444;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 24px;
        }

        .input-group label {
            display: block;
            color: #cbd5e1;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .input-group textarea {
            width: 100%;
            min-height: 300px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 16px;
            color: #e2e8f0;
            font-size: 0.95rem;
            font-family: 'Monaco', 'Courier New', monospace;
            resize: vertical;
        }

        .input-group textarea:focus {
            outline: none;
            border-color: #ef4444;
        }

        .analysis-options {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            color: #cbd5e1;
            cursor: pointer;
            margin: 0;
        }

        .btn {
            padding: 12px 24px;
            background: #ef4444;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .btn:hover {
            background: #dc2626;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .analysis-result {
            background: #1e293b;
            border-radius: 12px;
            padding: 30px;
        }

        .score-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #334155;
        }

        .score-number {
            font-size: 4rem;
            font-weight: 700;
        }

        .score-label {
            text-align: right;
        }

        .score-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .score-badge.excellent {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 2px solid #10b981;
        }

        .score-badge.good {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 2px solid #3b82f6;
        }

        .score-badge.needs-work {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 2px solid #f59e0b;
        }

        .score-badge.poor {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 2px solid #ef4444;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h3 {
            color: #ef4444;
            margin-bottom: 16px;
            font-size: 1.3rem;
        }

        .worked-section {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 20px;
        }

        .worked-section h3 {
            color: #10b981;
        }

        .worked-item {
            background: #0f172a;
            padding: 12px;
            margin: 8px 0;
            border-left: 3px solid #10b981;
            border-radius: 4px;
        }

        .failed-section {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            border-radius: 8px;
            padding: 20px;
        }

        .failed-section h3 {
            color: #ef4444;
        }

        .failed-item {
            background: #0f172a;
            padding: 12px;
            margin: 8px 0;
            border-left: 3px solid #ef4444;
            border-radius: 4px;
        }

        .missed-section {
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 20px;
        }

        .missed-section h3 {
            color: #f59e0b;
        }

        .missed-item {
            background: #0f172a;
            padding: 12px;
            margin: 8px 0;
            border-left: 3px solid #f59e0b;
            border-radius: 4px;
        }

        .missed-item .example {
            margin-top: 8px;
            padding: 8px;
            background: #1e293b;
            border-radius: 4px;
            font-style: italic;
            color: #fbbf24;
        }

        .turning-points-section {
            background: #1e293b;
            border: 2px solid #6366f1;
            border-radius: 8px;
            padding: 20px;
        }

        .turning-points-section h3 {
            color: #6366f1;
        }

        .turning-point {
            background: #0f172a;
            padding: 12px;
            margin: 8px 0;
            border-left: 3px solid #6366f1;
            border-radius: 4px;
        }

        .turning-point strong {
            color: #818cf8;
        }

        .violations-section {
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid #ef4444;
            border-radius: 8px;
            padding: 20px;
        }

        .violations-section h3 {
            color: #ef4444;
        }

        .violation-item {
            background: #0f172a;
            padding: 12px;
            margin: 8px 0;
            border-left: 3px solid #ef4444;
            border-radius: 4px;
        }

        .violation-item strong {
            color: #fca5a5;
        }

        .coaching-section {
            background: #1e293b;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 24px;
        }

        .coaching-section h3 {
            color: #10b981;
            margin-bottom: 16px;
        }

        .coaching-item {
            margin-bottom: 16px;
            padding: 16px;
            background: #0f172a;
            border-left: 4px solid #10b981;
            border-radius: 4px;
        }

        .coaching-item h4 {
            color: #6ee7b7;
            margin-bottom: 8px;
        }

        .coaching-item p {
            color: #cbd5e1;
            line-height: 1.8;
        }

        .practice-next {
            background: rgba(139, 92, 246, 0.1);
            border: 2px solid #8b5cf6;
            border-radius: 8px;
            padding: 20px;
        }

        .practice-next h3 {
            color: #8b5cf6;
            margin-bottom: 12px;
        }

        .practice-next ul {
            list-style: none;
            padding-left: 0;
        }

        .practice-next li {
            padding: 10px 0;
            color: #cbd5e1;
            border-bottom: 1px solid #1e293b;
        }

        .practice-next li:last-child {
            border-bottom: none;
        }

        .practice-next li::before {
            content: "‚Üí";
            color: #8b5cf6;
            font-weight: bold;
            margin-right: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        .hidden {
            display: none !important;
        }

        .history-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .history-modal.hidden {
            display: none !important;
        }

        .history-content {
            background: #1e293b;
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #334155;
        }

        .history-close {
            background: #ef4444;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .history-item {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            border-color: #ef4444;
            transform: translateX(4px);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-item-date {
            color: #94a3b8;
            font-size: 0.85rem;
        }

        .history-item-score {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .history-item-type {
            color: #cbd5e1;
            font-size: 0.9rem;
        }

        .history-item-preview {
            color: #64748b;
            font-size: 0.85rem;
            margin-top: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-empty {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .clear-history-btn {
            background: #334155;
            color: #e2e8f0;
            border: 1px solid #475569;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .clear-history-btn:hover {
            background: #ef4444;
            border-color: #ef4444;
        }

        .info-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .info-box p {
            color: #fca5a5;
            font-size: 0.9rem;
        }

        .info-box strong {
            color: #ef4444;
        }

        .setup-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .setup-box h4 {
            color: #3b82f6;
            margin-bottom: 8px;
        }

        .setup-box p {
            color: #93c5fd;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .setup-box a {
            color: #60a5fa;
            text-decoration: underline;
        }

        .api-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #0f172a;
            border-radius: 6px;
            font-size: 0.85rem;
            margin-top: 8px;
        }

        .api-status.connected {
            color: #10b981;
        }

        .api-status.not-connected {
            color: #ef4444;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="history-btn" onclick="openHistory()">
                üìã History <span class="history-count" id="historyCount">0</span>
            </button>
            <h1>Mode 3: Post-Mortem Analysis Engine</h1>
            <p class="subtitle">Brutal honest analysis of your sales calls ‚Ä¢ Doctrine-aligned coaching ‚Ä¢ What to practice next</p>
        </header>

        <div class="info-box">
            <p><strong>This is not a pat on the back.</strong> This tool gives you brutally honest feedback on what you did wrong, what you missed, and what to practice next. Expect red flags, not gold stars.</p>
        </div>

        <div class="setup-box" id="audioSetupBox" style="display: none;">
            <h4>üéôÔ∏è Audio Transcription Setup</h4>
            <p>To transcribe audio files, you need an OpenAI API key (used for Whisper speech-to-text).</p>
            <p><strong>Get API key:</strong> <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a></p>
            <p style="font-size: 0.85rem; color: #64748b;">Cost: ~$0.006 per minute of audio. A 60-min call = $0.36. You'll need to add a payment method to your OpenAI account.</p>
            <div id="apiKeyStatus"></div>
        </div>

        <!-- Call Type Selection -->
        <h2 style="color: #ef4444; margin-bottom: 16px;">What type of call was this?</h2>
        <div class="call-type-selector">
            <div class="call-type-card active" onclick="selectCallType('discovery')">
                <h3>Discovery</h3>
                <p>Qualification call</p>
            </div>
            <div class="call-type-card" onclick="selectCallType('demo')">
                <h3>Demo</h3>
                <p>Product presentation</p>
            </div>
            <div class="call-type-card" onclick="selectCallType('negotiation')">
                <h3>Negotiation</h3>
                <p>Pricing/terms discussion</p>
            </div>
            <div class="call-type-card" onclick="selectCallType('objection')">
                <h3>Objection Handling</h3>
                <p>Overcoming resistance</p>
            </div>
            <div class="call-type-card" onclick="selectCallType('general')">
                <h3>General</h3>
                <p>Mixed/other</p>
            </div>
        </div>

        <!-- Call Input Section -->
        <div class="input-section">
            <h2>Your Call Transcript / Notes</h2>

            <div class="input-group">
                <label>Option 1: Upload Audio Recording</label>
                <input type="file" id="audioFile" accept="audio/*" style="display: block; margin-bottom: 12px; padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: #e2e8f0; width: 100%;">
                <button class="btn btn-secondary" onclick="transcribeAudio()" id="transcribeBtn" style="margin-bottom: 16px; background: #334155; color: #e2e8f0;">
                    Transcribe Audio
                </button>
                <div id="transcriptionStatus" style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 16px;"></div>
            </div>

            <div style="text-align: center; margin: 20px 0; color: #64748b;">
                <span>‚Äî OR ‚Äî</span>
            </div>

            <div class="input-group">
                <label>Option 2: Paste Transcript / Notes Manually</label>
                <textarea id="callTranscript" placeholder="Paste your call transcript or notes here...

You: Hey Sarah, thanks for the time. I know you're busy so I'll keep this quick.

Sarah: No worries.

You: So, tell me about your current forecasting process.

Sarah: We use Excel. It's manual, takes forever.

You: How long does it take?

Sarah: Probably 40 hours a month across the team.

You: Okay. And what's the biggest pain point with that?

Sarah: Can't close books fast enough for board meetings.

[Continue with full transcript or detailed notes...]"></textarea>
            </div>

            <div class="analysis-options">
                <div class="checkbox-group">
                    <input type="checkbox" id="doctrineMode" checked>
                    <label for="doctrineMode">Doctrine-aligned analysis (brutal honesty)</label>
                </div>
            </div>

            <button class="btn" onclick="analyzeCall()">Run Post-Mortem Analysis</button>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden"></div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="history-modal hidden" onclick="closeHistory()">
        <div class="history-content" onclick="event.stopPropagation()">
            <div class="history-header">
                <h2 style="color: #ef4444;">Call History</h2>
                <div>
                    <button class="clear-history-btn" onclick="clearHistory()">Clear All</button>
                    <button class="history-close" onclick="closeHistory()">Close</button>
                </div>
            </div>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        const API_URL = 'https://shy-firefly-9ac5.joshuaoladipo1.workers.dev';
        let currentCallType = 'discovery';
        
        // OpenAI API key for Whisper transcription (user can add their own)
        let OPENAI_API_KEY = localStorage.getItem('openai_api_key') || '';

        // History tracking
        let callHistory = JSON.parse(localStorage.getItem('mode3_history') || '[]');

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateAPIKeyStatus();
            updateHistoryCount();
            
            // Show setup box on page load
            document.getElementById('audioSetupBox').style.display = 'block';
        });

        function updateHistoryCount() {
            const count = callHistory.length;
            const badge = document.getElementById('historyCount');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count === 0 ? 'none' : 'inline';
            }
        }

        function updateAPIKeyStatus() {
            const statusDiv = document.getElementById('apiKeyStatus');
            
            if (OPENAI_API_KEY) {
                const maskedKey = OPENAI_API_KEY.substring(0, 8) + '...' + OPENAI_API_KEY.substring(OPENAI_API_KEY.length - 4);
                statusDiv.innerHTML = `
                    <div class="api-status connected">
                        ‚úì API Key Connected: ${maskedKey}
                        <button class="btn btn-small" onclick="resetAPIKey()">Reset Key</button>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="api-status not-connected">
                        ‚úó No API Key Set
                        <button class="btn btn-small" onclick="setAPIKey()">Add API Key</button>
                    </div>
                `;
            }
        }

        function setAPIKey() {
            const userKey = prompt(
                'Enter your OpenAI API key:\n\n' +
                'Get one at: https://platform.openai.com/api-keys\n' +
                '(It will be saved locally in your browser)'
            );
            
            if (userKey && userKey.trim()) {
                OPENAI_API_KEY = userKey.trim();
                localStorage.setItem('openai_api_key', OPENAI_API_KEY);
                updateAPIKeyStatus();
                alert('API key saved! You can now transcribe audio files.');
            }
        }

        function resetAPIKey() {
            if (confirm('Remove saved API key?')) {
                localStorage.removeItem('openai_api_key');
                OPENAI_API_KEY = '';
                updateAPIKeyStatus();
            }
        }

        function selectCallType(type) {
            currentCallType = type;
            
            document.querySelectorAll('.call-type-card').forEach(card => {
                card.classList.remove('active');
            });
            event.target.closest('.call-type-card').classList.add('active');
        }

        async function transcribeAudio() {
            const audioFile = document.getElementById('audioFile').files[0];
            const statusDiv = document.getElementById('transcriptionStatus');
            const transcribeBtn = document.getElementById('transcribeBtn');

            if (!audioFile) {
                alert('Please select an audio file first.');
                return;
            }

            // Check if API key is set
            if (!OPENAI_API_KEY) {
                statusDiv.innerHTML = '<span style="color: #ef4444;">No API key set. Please add your OpenAI API key in the setup box above.</span>';
                document.getElementById('audioSetupBox').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            // Validate file size (max 25MB for Whisper API)
            const maxSize = 25 * 1024 * 1024; // 25MB
            if (audioFile.size > maxSize) {
                statusDiv.innerHTML = '<span style="color: #ef4444;">File too large. Maximum size is 25MB. Please use a shorter recording or compress the file.</span>';
                return;
            }

            // Show loading state
            statusDiv.innerHTML = `<span style="color: #3b82f6;">Transcribing ${audioFile.name}... This may take a minute.</span>`;
            transcribeBtn.disabled = true;
            transcribeBtn.textContent = 'Transcribing...';

            try {
                // Create FormData for multipart upload
                const formData = new FormData();
                formData.append('file', audioFile);
                formData.append('model', 'whisper-1');
                formData.append('language', 'en');
                formData.append('response_format', 'text');

                // Call OpenAI Whisper API
                const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = 'Transcription failed';
                    
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error?.message || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    
                    throw new Error(errorMessage);
                }

                const transcript = await response.text();

                if (!transcript || transcript.trim().length === 0) {
                    throw new Error('Transcription returned empty. The audio may be unclear or silent.');
                }

                // Insert transcription into textarea
                const textArea = document.getElementById('callTranscript');
                textArea.value = transcript;
                
                statusDiv.innerHTML = `<span style="color: #10b981;">‚úì Transcription complete! ${Math.round(audioFile.size / 1024)}KB processed. Text inserted below.</span>`;
                
                // Scroll to textarea
                textArea.scrollIntoView({ behavior: 'smooth', block: 'center' });

            } catch (error) {
                console.error('Transcription error:', error);
                
                let errorMessage = error.message;
                
                // Handle invalid API key
                if (errorMessage.includes('Invalid API key') || errorMessage.includes('Incorrect API key') || errorMessage.includes('401')) {
                    localStorage.removeItem('openai_api_key');
                    OPENAI_API_KEY = '';
                    updateAPIKeyStatus();
                    errorMessage = 'Invalid API key. Please add a valid OpenAI API key in the setup box above.';
                }
                
                statusDiv.innerHTML = `<span style="color: #ef4444;">‚úó ${errorMessage}</span>`;
            } finally {
                transcribeBtn.disabled = false;
                transcribeBtn.textContent = 'Transcribe Audio';
            }
        }

        async function analyzeCall() {
            const transcript = document.getElementById('callTranscript').value.trim();
            const doctrineMode = document.getElementById('doctrineMode').checked;

            if (!transcript) {
                alert('Please paste your call transcript or notes.');
                return;
            }

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Analyzing your call... This will be honest.</div>';
            resultsDiv.classList.remove('hidden');

            const callTypeContext = {
                discovery: "This was a discovery/qualification call. Focus on: question quality, qualification rigor, disqualification willingness, consequence identification, and whether they actually qualified the deal or just gathered information.",
                demo: "This was a demo call. Focus on: outcome anchoring vs feature touring, handling skepticism, proof over claims, business case clarity, and whether they showed value or just clicked through slides.",
                negotiation: "This was a negotiation call. Focus on: value anchoring, concession trading, standing firm vs caving, addressing objections, and whether they gave away value or traded strategically.",
                objection: "This was an objection handling call. Focus on: diagnosing real vs fake objections, addressing root causes, maintaining position, and whether they overcame the objection or just moved past it.",
                general: "This was a general sales call. Analyze overall sales effectiveness, communication quality, and strategic decision-making."
            };

            const doctrineGuidance = doctrineMode ? `
USE SALES DOCTRINE PRINCIPLES FOR ANALYSIS:

**Doctrine-Aligned Behaviors (what to look for and reward):**
- Disqualification willingness (offering to stop if not a fit)
- Consequence layering (quantifying pain and impact)
- Direct language (no corporate speak or hedging)
- Reversal questions (making buyer articulate criteria)
- Permission-based progression (getting buy-in, not permission theater)
- Scar tissue diagnosis (understanding past failures)
- Value quantification (putting dollar amounts on problems)
- Reality anchoring (grounding vague statements with specifics)

**Doctrine Violations (what to call out harshly):**
- Corporate speak ("leverage", "synergy", "touch base", "circle back")
- Excessive hedging ("might be", "potentially", "perhaps")
- Permission theater ("Would it be okay if I asked...")
- Feature dumping (listing capabilities without connecting to pain)
- No disqualification willingness (chasing every deal)
- Verbose/wordy (3 sentences when 1 works)
- Activity theater (scheduling next steps with no qualification)
- Fake urgency (pushing timeline without economic urgency)
- Question tourism (asking questions without diagnosis)` : '';

            const prompt = `You are a brutal, honest sales coach analyzing a sales call using elite sales principles.

CALL TYPE: ${currentCallType}
CONTEXT: ${callTypeContext[currentCallType]}

${doctrineGuidance}

CALL TRANSCRIPT:
${transcript}

PROVIDE BRUTALLY HONEST ANALYSIS:

1. **OVERALL SCORE (0-100)** - Be harsh. 70+ is rare.
2. **PERFORMANCE LEVEL** - EXCELLENT (85+) / GOOD (70-84) / NEEDS WORK (50-69) / POOR (<50)
3. **WHAT WORKED** - Specific moves that were effective (be brief if not much worked)
4. **WHAT FAILED** - Specific moves that hurt the deal or wasted time
5. **MISSED OPPORTUNITIES** - Critical moments where they should have done something different (provide SPECIFIC alternative language)
6. **TURNING POINTS** - Key moments where the call trajectory changed
7. **DOCTRINE VIOLATIONS** - Corporate speak, hedging, permission theater, etc. (if Doctrine mode enabled)
8. **COACHING POINTS** - 3-5 specific things to work on with clear guidance
9. **PRACTICE NEXT** - What skills/patterns to practice based on this analysis

BE BRUTALLY HONEST. Don't sugarcoat. If they failed to qualify, say it. If they talked too much, say it. If they used corporate speak, call it out. If they missed obvious opportunities, show them exactly what they should have said.

RESPOND IN THIS FORMAT:

SCORE: [0-100]
LEVEL: [EXCELLENT/GOOD/NEEDS WORK/POOR]

WHAT WORKED:
- [Specific move with brief reasoning]
- [Specific move with brief reasoning]
(If little worked, say so honestly)

WHAT FAILED:
- [Specific failure with impact]
- [Specific failure with impact]

MISSED OPPORTUNITIES:
- [What they should have done differently]
  BETTER: "[Exact alternative language they could have used]"
- [What they should have done differently]
  BETTER: "[Exact alternative language they could have used]"

TURNING POINTS:
- [Moment where call trajectory changed - for better or worse]
- [Moment where call trajectory changed - for better or worse]

DOCTRINE VIOLATIONS (if applicable):
- [Specific violation with example from transcript]
- [Specific violation with example from transcript]
(If none or not in Doctrine mode, write: "N/A")

COACHING POINTS:
1. [Specific skill to work on]: [How to improve it]
2. [Specific skill to work on]: [How to improve it]
3. [Specific skill to work on]: [How to improve it]

PRACTICE NEXT:
- [Specific pattern/skill to drill]
- [Specific pattern/skill to drill]
- [Specific pattern/skill to drill]`;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 3000,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });

                const data = await response.json();

                if (!response.ok || !data.content || !data.content[0]) {
                    throw new Error('Failed to get AI response');
                }

                const result = data.content[0].text;
                displayAnalysis(result);

            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: #f87171;">Error: ${error.message}</p>`;
            }
        }

        function displayAnalysis(analysisText) {
            const lines = analysisText.split('\n');
            let score = 0;
            let level = '';
            let worked = [];
            let failed = [];
            let missed = [];
            let turningPoints = [];
            let violations = [];
            let coaching = [];
            let practice = [];

            let section = '';
            let currentMissed = null;
            
            lines.forEach(line => {
                if (line.includes('SCORE:')) {
                    score = parseInt(line.match(/\d+/)[0]);
                } else if (line.includes('LEVEL:')) {
                    level = line.split(':')[1].trim();
                } else if (line.includes('WHAT WORKED:')) {
                    section = 'worked';
                } else if (line.includes('WHAT FAILED:')) {
                    section = 'failed';
                } else if (line.includes('MISSED OPPORTUNITIES:')) {
                    section = 'missed';
                } else if (line.includes('TURNING POINTS:')) {
                    section = 'turning';
                } else if (line.includes('DOCTRINE VIOLATIONS')) {
                    section = 'violations';
                } else if (line.includes('COACHING POINTS:')) {
                    section = 'coaching';
                } else if (line.includes('PRACTICE NEXT:')) {
                    section = 'practice';
                } else if (line.trim() && section) {
                    if (section === 'worked' && line.startsWith('-')) {
                        worked.push(line.substring(1).trim());
                    } else if (section === 'failed' && line.startsWith('-')) {
                        failed.push(line.substring(1).trim());
                    } else if (section === 'missed') {
                        if (line.startsWith('-')) {
                            if (currentMissed) missed.push(currentMissed);
                            currentMissed = { opportunity: line.substring(1).trim(), better: '' };
                        } else if (line.includes('BETTER:') && currentMissed) {
                            currentMissed.better = line.replace('BETTER:', '').trim().replace(/^["']|["']$/g, '');
                        }
                    } else if (section === 'turning' && line.startsWith('-')) {
                        turningPoints.push(line.substring(1).trim());
                    } else if (section === 'violations' && line.startsWith('-')) {
                        violations.push(line.substring(1).trim());
                    } else if (section === 'coaching' && line.match(/^\d/)) {
                        coaching.push(line.replace(/^\d+\.?\s*/, ''));
                    } else if (section === 'practice' && line.startsWith('-')) {
                        practice.push(line.substring(1).trim());
                    }
                }
            });
            
            if (currentMissed) missed.push(currentMissed);

            // Determine score color and badge
            let scoreColor = '#ef4444';
            let badgeClass = 'poor';
            if (score >= 85) {
                scoreColor = '#10b981';
                badgeClass = 'excellent';
            } else if (score >= 70) {
                scoreColor = '#3b82f6';
                badgeClass = 'good';
            } else if (score >= 50) {
                scoreColor = '#f59e0b';
                badgeClass = 'needs-work';
            }

            let html = `
                <div class="analysis-result">
                    <div class="score-header">
                        <div>
                            <h2 style="color: #ef4444; margin-bottom: 8px;">Call Analysis</h2>
                            <p style="color: #64748b;">Call Type: ${currentCallType.charAt(0).toUpperCase() + currentCallType.slice(1)}</p>
                        </div>
                        <div class="score-label">
                            <div class="score-badge ${badgeClass}">${level}</div>
                            <div class="score-number" style="color: ${scoreColor}">${score}</div>
                        </div>
                    </div>
            `;

            // What Worked
            if (worked.length > 0) {
                html += `
                    <div class="section worked-section">
                        <h3>‚úÖ What Worked</h3>
                        ${worked.map(item => `<div class="worked-item">${item}</div>`).join('')}
                    </div>
                `;
            }

            // What Failed
            if (failed.length > 0) {
                html += `
                    <div class="section failed-section">
                        <h3>‚ùå What Failed</h3>
                        ${failed.map(item => `<div class="failed-item">${item}</div>`).join('')}
                    </div>
                `;
            }

            // Missed Opportunities
            if (missed.length > 0) {
                html += `
                    <div class="section missed-section">
                        <h3>‚ö†Ô∏è Missed Opportunities</h3>
                        ${missed.map(item => `
                            <div class="missed-item">
                                ${item.opportunity}
                                ${item.better ? `<div class="example">Better: "${item.better}"</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Turning Points
            if (turningPoints.length > 0) {
                html += `
                    <div class="section turning-points-section">
                        <h3>üîÑ Turning Points</h3>
                        ${turningPoints.map(point => `
                            <div class="turning-point"><strong>Pivot:</strong> ${point}</div>
                        `).join('')}
                    </div>
                `;
            }

            // Doctrine Violations
            if (violations.length > 0 && !violations[0].toLowerCase().includes('n/a')) {
                html += `
                    <div class="section violations-section">
                        <h3>üö® Doctrine Violations</h3>
                        ${violations.map(v => `<div class="violation-item"><strong>‚ö†Ô∏è</strong> ${v}</div>`).join('')}
                    </div>
                `;
            }

            // Coaching Points
            if (coaching.length > 0) {
                html += `
                    <div class="section coaching-section">
                        <h3>üìö Coaching Points</h3>
                        ${coaching.map((point, i) => {
                            const parts = point.split(':');
                            const title = parts[0];
                            const description = parts.slice(1).join(':');
                            return `
                                <div class="coaching-item">
                                    <h4>${i + 1}. ${title}</h4>
                                    <p>${description}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            // Practice Next
            if (practice.length > 0) {
                html += `
                    <div class="section practice-next">
                        <h3>üéØ Practice Next</h3>
                        <ul>
                            ${practice.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            html += '</div>';

            document.getElementById('results').innerHTML = html;
            document.getElementById('results').classList.remove('hidden');

            // Save to history
            saveToHistory(analysisText, score, level);
        }

        function saveToHistory(analysisText, score, level) {
            const historyItem = {
                id: Date.now(),
                date: new Date().toISOString(),
                callType: currentCallType,
                score: score,
                level: level,
                transcript: document.getElementById('callTranscript').value.substring(0, 200),
                fullAnalysis: analysisText
            };

            callHistory.unshift(historyItem); // Add to beginning
            
            // Keep only last 50 analyses
            if (callHistory.length > 50) {
                callHistory = callHistory.slice(0, 50);
            }

            localStorage.setItem('mode3_history', JSON.stringify(callHistory));
            updateHistoryCount();
        }

        function openHistory() {
            const modal = document.getElementById('historyModal');
            const listDiv = document.getElementById('historyList');

            if (callHistory.length === 0) {
                listDiv.innerHTML = '<div class="history-empty">No call analyses yet. Run your first post-mortem to start building history.</div>';
            } else {
                listDiv.innerHTML = callHistory.map(item => {
                    const date = new Date(item.date);
                    const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    let scoreColor = '#ef4444';
                    if (item.score >= 85) scoreColor = '#10b981';
                    else if (item.score >= 70) scoreColor = '#3b82f6';
                    else if (item.score >= 50) scoreColor = '#f59e0b';

                    return `
                        <div class="history-item" onclick="loadHistoryItem(${item.id})">
                            <div class="history-item-header">
                                <div>
                                    <div class="history-item-type">${item.callType.toUpperCase()} Call</div>
                                    <div class="history-item-date">${dateStr}</div>
                                </div>
                                <div class="history-item-score" style="color: ${scoreColor}">${item.score}</div>
                            </div>
                            <div class="history-item-preview">${item.transcript}...</div>
                        </div>
                    `;
                }).join('');
            }

            modal.classList.remove('hidden');
        }

        // Make functions globally accessible
        window.openHistory = openHistory;

        function closeHistory() {
            const modal = document.getElementById('historyModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Make function globally accessible
        window.closeHistory = closeHistory;

        function loadHistoryItem(id) {
            const item = callHistory.find(h => h.id === id);
            if (!item) return;

            // Load transcript
            document.getElementById('callTranscript').value = item.transcript;
            
            // Display analysis
            displayAnalysis(item.fullAnalysis);

            // Close modal
            closeHistory();

            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        window.loadHistoryItem = loadHistoryItem;

        function clearHistory() {
            if (confirm('Delete all call history? This cannot be undone.')) {
                callHistory = [];
                localStorage.setItem('mode3_history', '[]');
                updateHistoryCount();
                closeHistory();
            }
        }

        window.clearHistory = clearHistory;

        // Initialize
        console.log('Mode 3: Post-Mortem Analysis Engine loaded');
    </script>
</body>
</html>
